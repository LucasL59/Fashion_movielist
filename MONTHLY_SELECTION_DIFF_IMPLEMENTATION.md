# 月份選擇差異功能實作說明

> **版本**：v2.2.0 | **實作日期**：2025-11-24

## 📋 功能概述

此功能讓客戶在選擇本月影片時，能夠同時檢視上個月已選擇的影片清單，並在送出前清楚地看到異動內容（下架哪些、新增哪些），確保客戶與管理員都能明確了解每月的影片更換狀況。

## 🎯 使用情境

### 範例情境

**10月份：**
- 可選清單：A, B, C, D, E（共30部）
- 客戶選擇：A, B, C（共15部）

**11月份：**
- 可選清單：B, D, E, F, G（共30部，其中 B、D 與10月重複）
- 客戶登入時：
  - 系統自動顯示「上月已選片單」區塊，列出 A, B, C
  - A 和 C 因不在11月清單中，顯示「已無法選」標記
  - B 因在11月清單中，預設勾選並可取消
- 客戶操作：
  - 取消 C 的勾選（實際上 C 已不在清單中，但仍顯示在上月區塊）
  - 在11月清單中選擇 E, F, G
- 送出前確認：
  - 彈出 Modal 顯示：
    - 上月總數：3 → 本月總數：4
    - 將下架：A, C（2部）
    - 新增：E, F, G（3部）
    - 保留：B（1部）

## 🛠 技術實作

### 1. 後端 API 擴充

#### 新增 API 端點

**`GET /api/selections/previous/:currentBatchId`**

根據當前批次 ID，自動計算上一個月的月份，查詢該月批次與用戶的選擇記錄。

```javascript
// 回應格式
{
  "success": true,
  "data": {
    "previousBatch": { ... },
    "previousSelection": { ... },
    "previousVideos": [ ... ]
  }
}
```

**實作位置：** `backend/src/routes/selections.js`

#### 選擇提交差異計算

修改 `POST /api/selections` 端點，在提交時自動計算並附加上月選擇資訊給郵件服務。

**實作位置：** `backend/src/routes/selections.js`

### 2. 郵件通知擴充

修改 `notifyAdminCustomerSelection` 函數，新增參數：
- `previousVideos`: 上月選擇的影片陣列
- `previousVideoIds`: 上月選擇的影片 ID 陣列

郵件模板新增：
- **異動摘要卡片**：顯示上月/本月總數、下架數、新增數、保留數
- **本月選擇清單**：為新增的影片加上「新增」標籤
- **上月選擇清單**：列出所有上月影片，標示「已下架」或「保留」

**實作位置：** `backend/src/services/emailService.js`

### 3. 前端狀態管理

#### 新增 State

```javascript
const [previousSelection, setPreviousSelection] = useState(null)
const [previousVideos, setPreviousVideos] = useState([])
const [previousVideoIds, setPreviousVideoIds] = useState([])
const [loadingPrevious, setLoadingPrevious] = useState(false)
const [showConfirmModal, setShowConfirmModal] = useState(false)
```

#### 資料載入流程

1. 當批次載入完成後，呼叫 `getPreviousSelection(batch.id)`
2. 若有上月選擇，自動預選在本月清單中仍存在的影片
3. 將上月選擇資料存入 state，用於 UI 顯示

**實作位置：** `frontend/src/pages/MovieSelection.jsx`

### 4. UI 組件

#### 上月片單區塊

顯示於頁面頂部，包含：
- 標題區：顯示總數與說明
- 影片卡片網格：
  - 已勾選：琥珀色邊框 + 勾選圖示
  - 已取消：紅色 X 圖示 + 半透明
  - 不在本月清單：灰色「已無法選」標記，無法點擊

樣式特色：
- 琥珀色主題（與本月清單的主色區分）
- 半透明效果突顯差異
- 清楚的視覺回饋

#### 確認 Modal

點擊「提交選擇」時觸發（僅當有上月選擇時），包含：

1. **異動摘要卡片**
   - 上月總數 / 本月總數
   - 將下架 / 新增 / 保留
   
2. **將下架的影片列表**（紅色主題）
   - 縮圖 + 片名 + X 圖示
   - 最多顯示高度限制，超過可滾動

3. **新增的影片列表**（綠色主題）
   - 縮圖 + 片名 + 勾選圖示
   - 最多顯示高度限制，超過可滾動

4. **保留的影片說明**（灰色主題）
   - 簡單文字說明

5. **操作按鈕**
   - 返回修改：關閉 Modal
   - 確認送出：執行提交

**實作位置：** `frontend/src/pages/MovieSelection.jsx`

## 📊 資料庫結構

### 使用現有欄位

- `batches.month` (YYYY-MM)：用於識別批次所屬月份
- `selections.video_ids`：UUID 陣列，儲存已選影片 ID
- `selections.batch_id`：關聯到特定批次

### 月份計算邏輯

```javascript
// 當前批次月份: 2024-11
const [year, month] = '2024-11'.split('-').map(Number)
const prevDate = new Date(year, month - 2, 1) // month - 2 因 JS Date 從 0 開始
const prevMonth = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`
// 結果: 2024-10
```

## 🔍 測試案例

### 案例 1：首次選擇（無上月資料）

**前置條件：**
- 用戶首次使用系統
- 或該用戶上月未選擇任何影片

**預期行為：**
- 不顯示「上月已選片單」區塊
- 點擊提交直接送出，不顯示確認 Modal
- 郵件通知中不包含異動摘要

### 案例 2：完全保留上月選擇

**前置條件：**
- 上月選擇：A, B, C
- 本月清單包含 A, B, C
- 用戶不做任何變更

**預期行為：**
- 上月區塊顯示 A, B, C，皆為勾選狀態
- 本月選擇自動包含 A, B, C
- 確認 Modal 顯示：
  - 下架：0
  - 新增：0
  - 保留：3

### 案例 3：部分下架 + 新增

**前置條件：**
- 上月選擇：A, B, C（共3部）
- 本月清單：B, D, E, F
- 用戶操作：取消 B，新增 E, F, G

**預期行為：**
- 上月區塊顯示 A, B, C
  - A, C 顯示「已無法選」
  - B 可取消勾選
- 本月清單中選擇 E, F, G
- 確認 Modal 顯示：
  - 上月總數：3 → 本月總數：3
  - 下架：A, B, C（3部）
  - 新增：E, F, G（3部）
  - 保留：0

### 案例 4：上月影片仍在本月清單

**前置條件：**
- 上月選擇：A, B
- 本月清單：A, B, C, D（A, B 重複）

**預期行為：**
- A, B 自動預選（既在上月區塊，也在本月清單中被勾選）
- 用戶可在本月清單中新增 C, D
- 確認 Modal 正確區分「保留」與「新增」

### 案例 5：多次提交

**前置條件：**
- 用戶在同一個月份多次修改選擇

**預期行為：**
- 每次提交都會更新資料庫（覆蓋舊選擇）
- 郵件通知發送給管理員
- 上月資料保持不變（仍為上個月的批次）

## 🎨 UI/UX 設計準則

### 色彩主題

- **上月區塊**：琥珀色（amber）系列
  - 背景：`glass-panel` + `border-amber-200/50`
  - 圖示：`bg-amber-100 text-amber-700`
  - 勾選邊框：`border-amber-400`

- **本月區塊**：主色（primary/紫色）系列
  - 維持原有設計
  
- **差異標示**：
  - 下架：紅色（`red-500`, `red-50`）
  - 新增：綠色（`green-500`, `green-50`）
  - 保留：灰色（`gray-500`, `gray-50`）

### 視覺層次

1. **上月片單區塊**：置於頂部，琥珀色邊框，半透明背景
2. **月份選擇器與控制列**：sticky 定位，毛玻璃效果
3. **本月影片清單**：主要內容區，原有設計
4. **浮動選擇 Bar**：底部固定，顯示已選數量
5. **確認 Modal**：最高層級，全屏遮罩

### 互動回饋

- **可點擊**：`cursor-pointer` + `hover:shadow-lg`
- **不可點擊**：`cursor-not-allowed` + `opacity-60`
- **已選擇**：勾選圖示 + 邊框高亮
- **已取消**：X 圖示 + 半透明遮罩

## 📝 注意事項

### 邊界條件處理

1. **上月批次不存在**
   - API 回傳空資料，不顯示上月區塊
   - 行為等同首次選擇

2. **上月批次存在但用戶未選擇**
   - API 回傳空影片陣列，不顯示上月區塊

3. **月份格式異常**
   - 後端會 fallback 為當前月份
   - 前端顯示錯誤訊息

4. **影片已被刪除**
   - 上月選擇的影片可能已從資料庫移除
   - 查詢時會過濾掉不存在的影片

### 效能考量

- 上月選擇載入與本月影片載入並行，減少等待時間
- 確認 Modal 採用 `createPortal` 避免 z-index 衝突
- 影片列表採用虛擬化（分頁）避免渲染過多卡片

### 相容性

- 與既有月份選擇器整合，切換月份時清空上月資料
- 與既有「已選記憶」功能並存，不衝突
- 郵件模板採用 inline CSS，確保各郵件客戶端相容

## 🔄 未來擴展

### 可能的功能增強

1. **批次比較**：允許用戶查看任意兩個月份的差異
2. **選擇歷史**：在 SelectionHistory 頁面中也顯示月份差異
3. **統計圖表**：管理員後台顯示每月新增/下架趨勢
4. **自動建議**：根據歷史選擇推薦本月影片

### 效能優化

1. 快取上月選擇資料，避免重複請求
2. 影片卡片使用 React.memo 減少重渲染
3. Modal 列表使用虛擬滾動處理大量影片

## 🐛 已知問題

目前無已知問題。

## 📞 支援與回饋

如遇到問題或有功能建議，請聯繫系統管理員或於專案 Issue 中提出。

---

**文件版本：** 1.0  
**最後更新：** 2025-11-24  
**維護者：** AI Assistant

