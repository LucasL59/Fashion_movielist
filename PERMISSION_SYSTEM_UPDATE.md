# 權限系統更新說明

## 📋 更新概要

系統已從原本的兩層權限（admin/customer）升級為三層權限架構，並新增用戶管理和批次刪除功能。

## 🎯 新的權限架構

### 1. Admin（管理員）
**完整權限**
- ✅ 上傳影片清單
- ✅ 編輯影片資訊
- ✅ 刪除批次
- ✅ 查看所有客戶選擇
- ✅ 設定提醒通知
- ✅ 管理所有用戶角色
- ✅ 查看所有功能

**頁面訪問**
- 上傳管理
- 影片清單
- 用戶管理（新增）
- 設定（含提醒設定）

### 2. Uploader（上傳者）⭐ 新增
**上傳和編輯權限**
- ✅ 上傳影片清單
- ✅ 編輯影片資訊
- ❌ 無法刪除批次
- ✅ 查看所有客戶選擇
- ❌ 無法設定提醒通知
- ❌ 無法管理用戶

**頁面訪問**
- 上傳管理
- 影片清單
- 設定（無提醒設定）

### 3. Customer（客戶）
**選擇權限**
- ✅ 瀏覽影片清單
- ✅ 選擇影片
- ✅ 提交選擇
- ❌ 無法上傳或編輯

**頁面訪問**
- 影片清單
- 設定（個人資料）

## 🆕 新功能

### 1. 用戶管理頁面
**路徑**: `/users`  
**權限**: 僅 admin

**功能**:
- 查看所有註冊用戶
- 變更用戶角色（admin/uploader/customer）
- 查看用戶註冊時間
- 無法變更自己的角色（安全機制）

**使用方式**:
1. 以 admin 身份登入
2. 點擊導航欄的「用戶管理」
3. 在下拉選單中選擇新角色
4. 系統自動儲存

### 2. 批次刪除功能
**權限**: 僅 admin

**功能**:
- 刪除整個批次
- 自動刪除該批次的所有影片
- 自動刪除該批次的所有選擇記錄
- 刪除前需確認

**使用方式**:
1. 在「上傳管理」頁面
2. 找到要刪除的批次
3. 點擊右側的垃圾桶圖示
4. 確認刪除

**⚠️ 警告**: 刪除操作無法復原！

### 3. 預設角色設定
**新註冊用戶預設為 `customer`**

管理員可以透過「用戶管理」頁面變更角色：
- customer → uploader（給予上傳權限）
- customer → admin（給予完整權限）
- uploader → admin（升級為管理員）

## 🔄 上傳機制說明

### 目前行為
**每次上傳都會建立新的批次**

- ✅ 不會覆蓋現有資料
- ✅ 保留歷史記錄
- ✅ 可以有多個同名批次

### 識別方式
- 每個批次有唯一的 UUID
- 批次名稱可以重複（如 "2025-11 影片清單"）
- 按上傳時間排序

### 範例
```
批次 1: 2025-11 影片清單 (2025-11-21 上傳)
批次 2: 2025-11 影片清單 (2025-11-22 更新上傳)
批次 3: 2025-12 影片清單 (2025-12-01 上傳)
```

### 建議工作流程
1. **上傳新清單**: 直接上傳，系統會建立新批次
2. **更新清單**: 
   - 方法 A: 刪除舊批次（admin），上傳新批次
   - 方法 B: 保留舊批次，上傳新批次（客戶可以看到歷史）
3. **管理歷史**: admin 可以刪除不需要的舊批次

## 🔒 資料庫層級安全

### Row Level Security (RLS) 政策

#### profiles 表
- 用戶可以查看和更新自己的資料
- admin 可以查看和更新所有用戶
- 註冊時自動建立 profile

#### batches 表
- 所有已認證用戶可以讀取
- admin 和 uploader 可以新增和更新
- 只有 admin 可以刪除

#### videos 表
- 所有已認證用戶可以讀取
- admin 和 uploader 可以新增和更新
- 只有 admin 可以刪除

#### selections 表
- 用戶可以查看、新增、更新自己的選擇
- admin 可以查看所有選擇

## 📊 權限對照表

| 功能 | Admin | Uploader | Customer |
|------|-------|----------|----------|
| 瀏覽影片 | ✅ | ✅ | ✅ |
| 選擇影片 | ✅ | ✅ | ✅ |
| 上傳清單 | ✅ | ✅ | ❌ |
| 編輯影片 | ✅ | ✅ | ❌ |
| 刪除批次 | ✅ | ❌ | ❌ |
| 查看所有選擇 | ✅ | ✅ | ❌ |
| 設定提醒 | ✅ | ❌ | ❌ |
| 管理用戶 | ✅ | ❌ | ❌ |

## 🚀 使用指南

### 管理員工作流程

1. **初始設定**
   - 註冊第一個帳號
   - 透過 Supabase Dashboard 將角色改為 `admin`
   - 登入系統

2. **管理用戶**
   - 前往「用戶管理」
   - 將需要上傳的用戶改為 `uploader`
   - 其他用戶保持 `customer`

3. **管理內容**
   - 上傳影片清單
   - 查看客戶選擇
   - 刪除舊的批次
   - 設定每月提醒

### 上傳者工作流程

1. **上傳清單**
   - 登入系統
   - 前往「上傳管理」
   - 上傳 Excel 檔案
   - 系統自動通知客戶

2. **查看反饋**
   - 查看客戶選擇
   - 準備客戶要的影片

### 客戶工作流程

1. **選擇影片**
   - 收到 Email 通知
   - 登入系統
   - 瀏覽影片清單
   - 選擇想要的影片
   - 提交選擇

2. **等待處理**
   - 系統自動通知管理員
   - 等待影片準備

## 🔧 技術細節

### 資料庫變更

```sql
-- 角色約束已更新
CHECK (role = ANY (ARRAY['admin', 'uploader', 'customer']))

-- 新增的 RLS 政策
- Admin and uploader can insert batches
- Admin and uploader can update batches
- Admin can delete batches
- Admin and uploader can insert videos
- Admin and uploader can update videos
- Admin can delete videos
- Admin can update all profiles
- Admin can view all users
```

### 前端變更

**新增文件**:
- `frontend/src/pages/UserManagement.jsx` - 用戶管理頁面

**修改文件**:
- `frontend/src/App.jsx` - 新增路由和權限檢查
- `frontend/src/components/Layout.jsx` - 新增導航連結
- `frontend/src/pages/AdminDashboard.jsx` - 新增刪除功能
- `frontend/src/pages/Settings.jsx` - 權限檢查

## 📝 注意事項

### 安全性
1. ✅ 無法變更自己的角色（防止鎖定）
2. ✅ 刪除前需要確認（防止誤刪）
3. ✅ RLS 政策保護資料（資料庫層級）
4. ✅ 前端路由保護（UI 層級）

### 最佳實踐
1. **至少保留一個 admin 帳號**
2. **定期檢查用戶角色**
3. **刪除批次前先確認沒有重要選擇**
4. **給予最小必要權限**（customer → uploader → admin）

## 🆘 常見問題

### Q: 如何將第一個用戶設為 admin？

A: 透過 Supabase Dashboard：
1. 前往 Table Editor → profiles
2. 找到該用戶
3. 將 role 改為 `admin`

### Q: uploader 和 admin 有什麼區別？

A: 
- uploader：只能上傳和編輯，適合日常操作人員
- admin：完整權限，適合系統管理員

### Q: 可以有多個 admin 嗎？

A: 可以！建議至少有 2 個 admin 以防萬一。

### Q: 刪除批次後可以恢復嗎？

A: 無法恢復！刪除前請確認。

### Q: 客戶可以看到其他客戶的選擇嗎？

A: 不行，RLS 政策確保客戶只能看到自己的選擇。

## 📞 需要幫助？

如有問題，請參考：
- [README.md](README.md) - 專案說明
- [QUICK_START.md](QUICK_START.md) - 快速開始
- [PROJECT_SUMMARY.md](PROJECT_SUMMARY.md) - 技術文件

---

**更新日期**: 2024-11-21  
**版本**: 2.0.0

