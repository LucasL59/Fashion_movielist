# 管理員已選片單總覽功能實作說明

> **版本**：v2.2.1 | **實作日期**：2025-11-25

## 📋 功能概述

此功能為系統管理員提供專屬頁面，能夠查看指定月份所有客戶的影片選擇清單與異動明細。管理員可以一目瞭然地了解：

- 各客戶在特定月份的選擇狀況
- 相較上個月的異動（下架了哪些、新增了哪些、保留了哪些）
- 客戶提交進度（已提交 vs 待提交）

## 🎯 使用情境

### 範例情境

**管理員需求：**
- 想知道 11 月份所有客戶的選擇狀況
- 想了解客戶 A 相較 10 月下架了哪些影片、新增了哪些影片
- 想快速找到尚未提交選擇的客戶

**操作流程：**
1. 管理員登入系統
2. 點擊導覽列「已選清單」
3. 選擇「2024年11月」
4. 查看所有客戶的卡片摘要
5. 展開特定客戶查看詳細清單與異動

## 🛠 技術實作

### 1. 後端 API

#### 新增端點

**`GET /api/selections/monthly-summary`**

**查詢參數：**
- `month` (必填)：月份格式 `YYYY-MM`，例如 `2024-11`

**權限要求：**
- 僅限 `admin` 角色

**處理流程：**

1. 驗證管理員權限
2. 驗證月份格式
3. 計算上一個月份（例如 11 月 → 10 月）
4. 查詢當前月份與上月的批次
5. 獲取所有客戶（role = 'customer'）
6. 批次查詢兩個月份的所有選擇記錄
7. 批次查詢所有涉及的影片詳情
8. 為每位客戶計算差異：
   - `added`: 本月新增的影片
   - `removed`: 上月有但本月沒有的影片
   - `kept`: 兩個月都有的影片
9. 組合並回傳完整摘要

**回應格式：**

```json
{
  "success": true,
  "data": {
    "month": "2024-11",
    "prevMonth": "2024-10",
    "currentBatch": {
      "id": "...",
      "name": "11月片單",
      "month": "2024-11",
      "created_at": "..."
    },
    "previousBatch": {
      "id": "...",
      "name": "10月片單",
      "month": "2024-10",
      "created_at": "..."
    },
    "summaries": [
      {
        "customer": {
          "id": "customer-uuid",
          "name": "客戶名稱",
          "email": "customer@example.com"
        },
        "currentSelection": {
          "videoCount": 5,
          "submittedAt": "2024-11-15T10:30:00Z",
          "videos": [
            {
              "id": "video-uuid",
              "title": "影片標題",
              "title_en": "Video Title",
              "thumbnail_url": "https://..."
            }
          ]
        },
        "previousSelection": {
          "videoCount": 3,
          "submittedAt": "2024-10-15T10:30:00Z",
          "videos": [...]
        },
        "diff": {
          "added": [...],      // 本月新增的影片
          "removed": [...],    // 上月有但本月沒有的影片
          "kept": [...],       // 兩個月都有的影片
          "addedCount": 2,
          "removedCount": 1,
          "keptCount": 2
        }
      }
    ]
  }
}
```

**實作位置：** `backend/src/routes/selections.js`

### 2. 前端 API 客戶端

新增函數 `getMonthlySelectionSummary(month)` 於 `frontend/src/lib/api.js`，封裝 API 請求並處理錯誤。

```javascript
export async function getMonthlySelectionSummary(month) {
  const response = await api.get('/api/selections/monthly-summary', { params: { month } })
  return response.data
}
```

### 3. 管理員頁面

#### 新增頁面組件

**檔案位置：** `frontend/src/pages/AdminSelectionSummary.jsx`

**主要功能：**

1. **月份選擇器**
   - 下拉選單顯示所有可用月份
   - 預設選擇當前月份
   - 切換月份時重新載入資料

2. **搜尋功能**
   - 即時搜尋客戶名稱或 Email
   - 大小寫不敏感

3. **統計摘要卡片**
   - 總客戶數
   - 已提交數量
   - 待提交數量

4. **客戶清單卡片**
   - **折疊狀態**：
     - 客戶名稱與 Email
     - 提交狀態標籤（已提交/待提交）
     - 上月與本月的影片數量
     - 展開/收合按鈕
   
   - **展開狀態**：
     - **異動摘要區塊**（琥珀色背景）
       - 下架數量（紅色圖示）
       - 新增數量（綠色圖示）
       - 保留數量（灰色圖示）
     
     - **本月選擇區塊**
       - 影片清單（含縮圖、標題）
       - 新增的影片標記「新增」綠色標籤
       - 提交時間
     
     - **上月選擇區塊**
       - 影片清單（含縮圖、標題）
       - 已下架的影片標記「已下架」紅色標籤
       - 保留的影片標記「保留」灰色標籤
       - 提交時間

5. **空狀態處理**
   - 無資料時顯示友善提示
   - 搜尋無結果時提供建議

6. **載入狀態**
   - 顯示載入動畫
   - 防止重複請求

#### UI/UX 設計準則

**色彩主題：**
- 異動摘要：琥珀色（amber）
- 下架標記：紅色（red）
- 新增標記：綠色（green）
- 保留標記：灰色（gray）
- 已提交：翠綠色（emerald）
- 待提交：琥珀色（amber）

**互動設計：**
- 卡片可點擊展開/收合
- Hover 效果提供視覺回饋
- 搜尋即時過濾，無需按鈕
- 月份切換自動載入

**響應式設計：**
- 桌面：完整顯示所有資訊
- 平板：調整卡片佈局
- 手機：隱藏部分次要資訊，保持核心功能

### 4. 路由與導覽

#### 路由註冊

**檔案：** `frontend/src/App.jsx`

```jsx
<Route path="/selection-summary" element={
  <ProtectedRoute requiredRole="admin">
    <Layout>
      <AdminSelectionSummary />
    </Layout>
  </ProtectedRoute>
} />
```

#### 導覽連結

**檔案：** `frontend/src/components/Layout.jsx`

- 桌面導覽：在管理員選單中新增「已選清單」連結
- 行動導覽：同步新增至行動選單
- 圖示：使用 `ListChecks` 圖示

## 📊 資料流程

```
[管理員] 
   ↓ 選擇月份
[前端頁面] 
   ↓ API 請求
[後端 API] 
   ↓ 查詢資料庫
[Supabase]
   ↓ 回傳資料
[後端處理]
   ↓ 計算差異
[前端渲染]
   ↓ 顯示結果
[管理員查看]
```

## 🔍 測試案例

### 案例 1：正常查看

**步驟：**
1. 管理員登入
2. 點擊「已選清單」
3. 選擇有資料的月份

**預期：**
- 顯示所有客戶清單
- 統計數字正確
- 可展開查看詳情

### 案例 2：搜尋功能

**步驟：**
1. 在搜尋框輸入客戶名稱
2. 觀察清單變化

**預期：**
- 即時過濾符合的客戶
- 不符合的客戶被隱藏
- 統計數字更新

### 案例 3：無資料狀態

**步驟：**
1. 選擇沒有任何提交的月份
2. 或搜尋不存在的客戶

**預期：**
- 顯示友善的空狀態提示
- 統計顯示 0

### 案例 4：展開客戶詳情

**步驟：**
1. 點擊客戶卡片
2. 查看展開內容

**預期：**
- 顯示異動摘要
- 本月選擇標記正確
- 上月選擇標記正確
- 影片清單完整

### 案例 5：月份切換

**步驟：**
1. 切換不同月份
2. 觀察資料更新

**預期：**
- 載入動畫顯示
- 資料正確更新
- 展開狀態重置

## 📝 注意事項

### 效能考量

1. **批次查詢優化**
   - 一次性獲取所有客戶
   - 批次查詢兩個月份的選擇
   - 批次查詢所有涉及的影片
   - 避免 N+1 查詢問題

2. **前端渲染優化**
   - 使用虛擬化處理大量客戶
   - 展開狀態按需渲染
   - 搜尋使用前端過濾，無需重新請求

3. **快取策略**
   - 月份資料可快取
   - 切換回已查看的月份時可復用

### 權限控制

- API 端點嚴格檢查 admin 角色
- 前端路由使用 `ProtectedRoute` 保護
- 非管理員無法訪問此頁面

### 邊界條件

1. **無批次資料**
   - 當前月份或上月沒有批次
   - 顯示空狀態，不報錯

2. **客戶未提交**
   - `currentSelection` 為 null
   - 顯示「待提交」狀態

3. **上月無選擇**
   - `previousSelection` 為 null
   - 不顯示異動摘要
   - 只顯示本月選擇

4. **影片已刪除**
   - 選擇記錄中的影片可能已從資料庫移除
   - 查詢時會過濾掉不存在的影片

## 🔄 與現有功能的整合

### 與客戶選擇頁面的關係

- 客戶在 `MovieSelection.jsx` 提交選擇
- 管理員在 `AdminSelectionSummary.jsx` 查看所有客戶的選擇
- 兩者使用相同的資料來源（`selections` 表）

### 與管理員儀表板的關係

- `AdminDashboard.jsx` 顯示當前月份的即時統計
- `AdminSelectionSummary.jsx` 提供歷史月份的詳細清單
- 互補而非重複

### 與選擇歷史的關係

- `SelectionHistory.jsx` 是客戶查看自己的歷史
- `AdminSelectionSummary.jsx` 是管理員查看所有客戶
- 資料結構類似，視角不同

## 🐛 已知問題

目前無已知問題。

## 📞 支援與回饋

如遇到問題或有功能建議，請聯繫系統管理員或於專案 Issue 中提出。

---

**文件版本：** 1.0  
**最後更新：** 2025-11-25  
**維護者：** AI Assistant





