# 上傳月份識別邏輯優化

> **版本：** v2.2.1  
> **修正日期：** 2025-11-24  
> **類型：** Bug Fix & Enhancement

## 🐛 問題描述

### 原始問題

在 v2.2.0 之前，當使用者上傳影片清單時，即使：
- 檔案名稱為「10月清單.xlsx」
- 批次名稱輸入為「10月」

系統仍會將批次錯誤地歸類為當前系統日期的月份（例如11月），導致月份識別錯誤。

### 根本原因

原有的月份識別邏輯：
1. 僅從檔案名稱提取月份
2. 如果無法提取，直接 fallback 到當前系統月份
3. **沒有考慮使用者輸入的批次名稱**

這導致即使使用者明確輸入「10月清單」，系統仍會使用當前月份。

## ✅ 解決方案

### 改進的月份識別邏輯

現在系統會按照以下優先順序提取月份資訊：

```
1. 使用者輸入的批次名稱（最高優先）
   ↓ 無法提取
2. 檔案名稱
   ↓ 無法提取
3. 當前系統月份（最後 fallback）
```

### 支援的月份格式

系統現在能識別以下格式：

| 格式範例 | 說明 | 提取結果 |
|---------|------|---------|
| `10月` | 僅月份 | `2024-10`（使用當前年份） |
| `2024年10月` | 年份+月份 | `2024-10` |
| `2024-10` | ISO 格式 | `2024-10` |
| `202410` | 壓縮格式 | `2024-10` |
| `10月清單` | 包含其他文字 | `2024-10` |
| `UIP片單10月.xlsx` | 檔名中的月份 | `2024-10` |

## 🔧 技術實作

### 後端改進

**檔案位置：** `backend/src/routes/upload.js`

#### 改進前

```javascript
// 只從檔名提取
const fileName = file.name;
for (const pattern of monthPatterns) {
  const match = fileName.match(pattern);
  // ...
}
// 無法提取就使用當前月份
if (!extractedMonth) {
  extractedMonth = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
}
```

#### 改進後

```javascript
// 提取月份的通用函數
function extractMonthFromText(text) {
  const monthPatterns = [
    /(\d{4})[年\-]?(\d{1,2})月?/,  // 2024年11月, 2024-11
    /(\d{1,2})月/,                  // 11月, 10月
  ];
  // ... 提取邏輯
}

// 優先從批次名稱提取，其次檔名
extractedMonth = extractMonthFromText(userBatchName) || 
                 extractMonthFromText(fileName);

// 最後才 fallback
if (!extractedMonth) {
  // 使用當前月份
  console.log(`⚠️  無法從檔名或批次名稱提取月份，使用當前月份`);
}
```

**關鍵改進：**
1. 建立可重用的 `extractMonthFromText` 函數
2. 優先檢查 `userBatchName`（使用者輸入）
3. 次要檢查 `fileName`（檔案名稱）
4. 最後才使用當前月份，並記錄警告日誌

### 前端改進

**檔案位置：** `frontend/src/pages/UploadManagement.jsx`

#### 1. 智慧預填批次名稱

當使用者選擇檔案時，系統會：
1. 嘗試從檔名提取月份
2. 如果成功，自動填入「YYYY-MM 影片清單」
3. 如果失敗，使用當前月份

```javascript
function handleFileChange(e) {
  const selectedFile = e.target.files[0]
  if (selectedFile && !batchName) {
    // 嘗試從檔名提取月份
    const extractedMonth = extractMonthFromText(selectedFile.name)
    if (extractedMonth) {
      setBatchName(`${extractedMonth} 影片清單`)
    } else {
      // fallback 到當前月份
      setBatchName(`${currentYear}-${currentMonth} 影片清單`)
    }
  }
}
```

#### 2. 使用者提示優化

新增清楚的提示訊息：

```jsx
<p className="text-xs text-amber-600 mt-1.5">
  💡 提示：系統會自動從批次名稱或檔名中識別月份（如「10月」或「2024-10」）
</p>
```

**改進點：**
- 使用琥珀色（amber）突顯重要提示
- 清楚說明系統如何識別月份
- 提供範例格式

## 📊 使用情境對比

### 情境 1：檔名包含月份

**操作：**
- 檔案：`UIP片單10月.xlsx`
- 批次名稱：（留空或輸入其他）

**v2.2.0 之前：**
```
提取月份：2024-10 ✅（從檔名）
```

**v2.2.1：**
```
提取月份：2024-10 ✅（從檔名）
自動填入批次名稱：「2024-10 影片清單」
```

---

### 情境 2：使用者手動輸入月份

**操作：**
- 檔案：`清單資料.xlsx`（檔名無月份資訊）
- 批次名稱：`10月清單`

**v2.2.0 之前：**
```
提取月份：2024-11 ❌（fallback 到系統當前月份）
批次顯示為 11月，但使用者想要 10月
```

**v2.2.1：**
```
提取月份：2024-10 ✅（從批次名稱）
正確歸類為 10月
```

---

### 情境 3：批次名稱優先

**操作：**
- 檔案：`UIP片單11月.xlsx`
- 批次名稱：`10月清單`（使用者修改）

**v2.2.0 之前：**
```
提取月份：2024-11 ❌（只看檔名）
忽略使用者的明確意圖
```

**v2.2.1：**
```
提取月份：2024-10 ✅（優先使用批次名稱）
尊重使用者的明確輸入
```

## 🧪 測試案例

### 測試 1：批次名稱優先級

**步驟：**
1. 上傳檔案：`測試11月.xlsx`
2. 批次名稱輸入：`10月清單`
3. 點擊上傳

**預期結果：**
- 月份識別為 `2024-10`
- 批次歸類在 10月
- 後端日誌顯示：`📅 識別月份: 2024-10`

---

### 測試 2：檔名識別

**步驟：**
1. 上傳檔案：`UIP片單10月.xlsx`
2. 批次名稱：自動填入（不修改）
3. 點擊上傳

**預期結果：**
- 批次名稱自動填入：`2024-10 影片清單`
- 月份識別為 `2024-10`
- 批次歸類在 10月

---

### 測試 3：Fallback 機制

**步驟：**
1. 上傳檔案：`清單資料.xlsx`（無月份資訊）
2. 批次名稱輸入：`測試清單`（無月份資訊）
3. 點擊上傳

**預期結果：**
- 月份識別為當前系統月份（例如 `2024-11`）
- 後端日誌顯示：`⚠️  無法從檔名或批次名稱提取月份，使用當前月份: 2024-11`
- 批次歸類在當前月份

---

### 測試 4：不同格式支援

**步驟：**
測試以下批次名稱輸入：

| 輸入 | 預期識別 |
|------|---------|
| `10月` | `2024-10` |
| `2024年10月` | `2024-10` |
| `2024-10` | `2024-10` |
| `202410` | `2024-10` |
| `10月片單` | `2024-10` |
| `2023年12月清單` | `2023-12` |

**驗證方法：**
查看後端日誌中的 `📅 識別月份:` 輸出

## 📝 注意事項

### 對既有資料的影響

- ✅ **無影響**：此改進僅影響新上傳的批次
- ✅ **向後相容**：既有批次的月份資訊不受影響
- ✅ **無需遷移**：不需要修改既有的資料庫記錄

### 使用建議

1. **最佳實踐**：在批次名稱中明確包含月份資訊
   - 好：`10月清單`、`2024-10 影片清單`
   - 可：依賴檔名（如 `UIP片單10月.xlsx`）
   - 避免：完全不包含月份資訊

2. **多月份上傳**：如果需要為不同月份上傳清單
   - 修改批次名稱為對應月份
   - 不要只依賴檔名

3. **檢查確認**：上傳後可在批次列表中確認月份是否正確

## 🔄 未來改進可能

1. **月份選擇器**：在上傳介面新增下拉式月份選擇器
2. **視覺化提示**：顯示系統識別到的月份，讓使用者確認
3. **批次編輯**：允許修改已上傳批次的月份歸屬

## 📞 相關文件

- 完整系統說明：[README.md](README.md)
- 月份差異功能：[MONTHLY_SELECTION_DIFF_IMPLEMENTATION.md](MONTHLY_SELECTION_DIFF_IMPLEMENTATION.md)
- 最新更新：[UPDATE_SUMMARY_2025_11_24_v2.md](UPDATE_SUMMARY_2025_11_24_v2.md)

---

**版本：** v2.2.1  
**修正日期：** 2025-11-24  
**修正者：** 開發團隊

